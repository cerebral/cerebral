/* globals describe it expect  */
import { transform } from 'babel-core'
import { Tag } from 'cerebral/tags'
import plugin from '../index'

const pluginOptions = {
  babelrc: false,
  presets: ['es2015'],
  plugins: [plugin],
}

describe('Run transformed dot syntax', () => {
  it('should evaluate to a tag with nested tags', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      state.a[state.b];
    `

    const context = {
      state: {
        a: {
          c: 'Working!',
        },
        b: 'c',
        get(path) {
          return path.split('.').reduce((acc, curr) => {
            return acc[curr]
          }, context.state)
        },
      },
    }
    const { code: result } = transform(code, pluginOptions)
    const tag = eval(result) // eslint-disable-line no-eval
    expect(tag).toMatchSnapshot()
    expect(tag).toBeInstanceOf(Tag)
    expect(tag.getValue(context)).toEqual(context.state.a.c)
  })

  it('should allow to access with expressions in ${}', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      const name = 'c';
      state.a[name][1+1];
    `

    const context = {
      state: {
        a: {
          c: {
            2: 'Working!',
          },
        },
        get(path) {
          return path.split('.').reduce((acc, curr) => {
            return acc[curr]
          }, context.state)
        },
      },
    }
    const { code: result } = transform(code, pluginOptions)
    const tag = eval(result) // eslint-disable-line no-eval
    expect(tag).toBeInstanceOf(Tag)
    expect(tag.getValue(context)).toEqual(context.state.a.c[2])
  })
})
