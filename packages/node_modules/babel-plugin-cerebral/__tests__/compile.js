/* globals describe it expect */
import { transform } from 'babel-core'
import plugin from '../index'

const pluginOptions = {
  babelrc: false,
  plugins: [plugin],
}

describe('Transform dot syntax to template tags', () => {
  it('should transforms simple state dot syntax', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      state.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should allow nested usage', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      state.hello[state.world];
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should ignore variable when shadowed', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      (state) => state.hello[state.world];
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should allow imported variable to be renamed', () => {
    const code = `
      import {state as anotherName} from 'cerebral/proxy';
      (state) => anotherName.hello[anotherName.world];
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should support expression in property accessor', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      state.a[1+1]
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should not do anything when cerebral/proxy is not imported', () => {
    const code = `
      import {state} from 'other-module';
      state.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should allow for string accessors', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      state.a['b']
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should allow access to variables', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      const a = 'a';
      const b = 'b'
      state.a[a+b]
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should track variable assigment', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      const a = state;
      const b = a;
      b.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should ignore unbound variable', () => {
    const code = `
      import {state} from 'cerebral/proxy';
      notState.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should throw when import is not allowed', () => {
    const code = `
      import {wrongImport} from 'cerebral/proxy';
    `
    expect(() => {
      transform(code, pluginOptions)
    }).toThrowErrorMatchingSnapshot()
  })

  it('should throw on default import', () => {
    const code = `
      import state from 'cerebral/proxy';
      state.hello.world;
    `
    expect(() => {
      transform(code, pluginOptions)
    }).toThrowErrorMatchingSnapshot()
  })
})

describe('Transform imports containing "cerebral.proxy"', () => {
  it('should rewrite tags but not import', () => {
    const code = `
      import {state} from 'app.cerebral.proxy.ts';
      state.world
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should allow renaming of imports', () => {
    const code = `
      import {state as fooBar} from 'app.cerebral.proxy.ts';
      fooBar.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })
  it('should not complain about other imports', () => {
    const code = `
      import {state, foo, bar} from 'app.cerebral.proxy.ts';
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })
})

describe('Transform namespaced imports', () => {
  it('should transform simple state dot syntax', () => {
    const code = `
      import * as proxies from 'cerebral/proxy';
      proxies.state.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })

  it('should complain about wront tag names', () => {
    const code = `
      import * as proxies from 'cerebral/proxy';
      proxies.foo.bar;
    `
    expect(() => {
      transform(code, pluginOptions)
    }).toThrowErrorMatchingSnapshot()
  })

  it('should keep track of bound variables', () => {
    const code = `
      import * as proxies from 'cerebral/proxy';
      const bar = proxies;
      (proxies) => proxies.state.hello.world;
      (proxies) => bar.state.hello.world;
    `
    const { code: result } = transform(code, pluginOptions)
    expect(result).toMatchSnapshot()
  })
})
