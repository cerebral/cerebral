import StorageProvider from './StorageProvider'

export { default as StorageProviderError } from './StorageProviderError'

export default options => {
  return ({ name, controller }) => {
    controller.once('initialized:model', () => {
      const targetStorage = options.target || localStorage

      Object.keys(options.sync || {}).forEach(syncKey => {
        const value = targetStorage.getItem(options.prefix + syncKey)

        if (!value) {
          return
        }

        const path = options.sync[syncKey].split('.')
        controller.model.set(path, options.json ? JSON.parse(value) : value)
      })
    })

    return {
      provider: StorageProvider(name, options),
    }
  }
}
