/* eslint-env mocha */
/* eslint-disable no-console */
import * as assert from 'assert'
import addressbar from 'addressbar'
import Router from './'
import { makeTest, triggerUrlChange } from '../test/helper'

describe('onlyHash', () => {
  beforeEach(() => {
    console.warn.warnings = []
    addressbar.value = '/'
    addressbar.removeAllListeners('change')
  })

  it('should handle only hash urls', () => {
    let count = 0
    const controller = makeTest(
      Router({
        onlyHash: true,
        preventAutostart: true,
        routes: {
          '/': 'home',
        },
      }),
      {
        home: [
          () => {
            count++
          },
        ],
      }
    )

    triggerUrlChange('/#/')
    triggerUrlChange('/#/?query=')
    triggerUrlChange('/#/#hash')
    triggerUrlChange('/#/?query=#hash')
    triggerUrlChange('/')
    assert.equal(count, 5)

    assert.doesNotThrow(() => {
      controller.getSequence('home')({
        foo: 'bar',
      })
    })

    assert.doesNotThrow(() => {
      controller.getSequence('home')()
    })

    triggerUrlChange('/#/foo')
    triggerUrlChange('/foo#/')
    assert.equal(console.warn.warnings.length, 1)
    assert.equal(addressbar.value, addressbar.origin + '/foo#/')
  })

  it('should work with baseUrl', () => {
    let count = 0
    const controller = makeTest(
      Router({
        onlyHash: true,
        baseUrl: '/base',
        preventAutostart: true,
        routes: {
          '/': 'home',
        },
      }),
      {
        home: [
          () => {
            count++
          },
        ],
      }
    )

    triggerUrlChange('/base#/')
    triggerUrlChange('/base#/?query=')
    triggerUrlChange('/base#/#hash')
    triggerUrlChange('/base#/?query=#hash')
    triggerUrlChange('/base')
    assert.equal(count, 5)

    assert.doesNotThrow(() => {
      controller.getSequence('home')({
        foo: 'bar',
      })
    })

    assert.doesNotThrow(() => {
      controller.getSequence('home')()
    })

    triggerUrlChange('/base#/foo')
    triggerUrlChange('/base/foo#/')
    assert.equal(console.warn.warnings.length, 1)
    assert.equal(addressbar.value, addressbar.origin + '/base/foo#/')
  })

  it('should work with autodetected baseUrl', () => {
    addressbar.value = addressbar.origin + '/base/'
    let count = 0
    const controller = makeTest(
      Router({
        onlyHash: true,
        preventAutostart: true,
        routes: {
          '/': 'home',
        },
      }),
      {
        home: [
          () => {
            count++
          },
        ],
      }
    )

    triggerUrlChange('/base/#/')
    triggerUrlChange('/base/#/?query=')
    triggerUrlChange('/base/#/#hash')
    triggerUrlChange('/base/#/?query=#hash')
    triggerUrlChange('/base/')
    assert.equal(count, 5)

    assert.doesNotThrow(() => {
      controller.getSequence('home')({
        foo: 'bar',
      })
    })

    assert.doesNotThrow(() => {
      controller.getSequence('home')()
    })

    triggerUrlChange('/base/#/foo')
    triggerUrlChange('/base/foo#/')
    assert.equal(console.warn.warnings.length, 1)
    assert.equal(addressbar.value, addressbar.origin + '/base/foo#/')
  })
})
