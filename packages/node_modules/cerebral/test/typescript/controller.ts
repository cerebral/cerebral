import * as React from 'react'
import { render } from 'react-dom'
import { Controller, Module, Signal } from '../..'
import Devtools from '../../devtools'
import { set } from '../../operators'
import { Container } from '../../react'
import Router from '@cerebral/router'
import { props, signal, state } from '../../tags'
import * as signals from './signals'

declare var process: any

const router = Router({
  routes: [
    { path: '/', signal: 'foo' }
  ],
  query: true,
  onlyHash: true
})

const foo: Module = {
  state: { bar: 'bar' },
  signals: {
    foo: [set(state`bar`, props`foo`)]
  }
}

const foobar: Module = (module) => {
  module.name = 'foobar'
  return {
    state: {
      foo: 'bar'
    }
  }
}

const controller = Controller({
  state: {
    app: {
      name: 'Cerebral',
      ready: false
    }
  },
  modules: {
    foo,
    foobar
  },
  catch: new Map([
    [Error, []]
  ]),
  signals: { ...signals },
  devtools: process.env.NODE_ENV === 'production'
    ? undefined
    : Devtools({
      host: 'localhost:8585',
      reconnect: true
    })
})

render(
  React.createElement(
    Container,
    { controller },
    React.createElement('div', null, 'Hello Cerebral')
  ),
  document.querySelector('#app')
)

const appName = controller.getState('app.name')
const appState = controller.getState()

const appReady: Signal = controller.getSignal('appReadySignal')
appReady()
