import {
  Computed,
  ModuleClass,
  BaseControllerClass,
  Sequence,
  ControllerOptions,
} from '../'

type Action<P, T> = (context: { props: P }) => T

export interface SnapshotTest {
  mutate: (method: string, path: string, value: any) => SnapshotTest
  mock: (path: string, value: any) => SnapshotTest
  mockResolvedPromise: (path: string, value: any) => SnapshotTest
  mockRejectedPromise: (path: string, value: any) => SnapshotTest
  run: (signal: string, payload: {}) => Promise<any>
}

export function Snapshot(module: ModuleClass): SnapshotTest

export interface RunActionResult<P, T> {
  controller: BaseControllerClass
  props: P
  state: any
  output: T
}

interface RunSignalResult0<P, T0> {
  '0': RunActionResult<P, T0>
}

interface RunSignalResult1<P, T0, T1> {
  '0': RunActionResult<P, T0>
  '1': RunActionResult<P, T1>
}

interface RunSignalResult2<P, T0, T1, T2> {
  '0': RunActionResult<P, T0>
  '1': RunActionResult<P, T1>
  '2': RunActionResult<P, T2>
}

export function runAction<P = any, T = any>(
  action: Action<P, Promise<T> | T>,
  fixtures?: { props: P & any } & any
): Promise<RunActionResult<P, T>>

export function runCompute<T>(computed: Computed<T>, fixtures?: any): T

export function runSignal<P, T0>(
  signal: [Action<P, Promise<T0> | T0>],
  fixtures?: { props: P & any } & any,
  options?: any
): Promise<RunSignalResult0<P, T0>>

export function runSignal<P, T0, T1>(
  signal: [Action<P, Promise<T0> | T0>, Action<any, Promise<T1> | T1>],
  fixtures?: { props: P & any } & any,
  options?: any
): Promise<RunSignalResult1<P, T0, T1>>

export function runSignal<P, T0, T1, T2>(
  signal: [
    Action<P, Promise<T0> | T0>,
    Action<any, Promise<T1> | T1>,
    Action<any, Promise<T2> | T2>
  ],
  fixtures?: { props: P & any } & any,
  options?: any
): Promise<RunSignalResult2<P, T0, T1, T2>>

export function runSignal(
  signal: Sequence,
  fixtures?: any,
  options?: any
): Promise<any>

interface CerebralTestType {
  controller: BaseControllerClass
  runSignal<T = any>(signal: Sequence, props: any): Promise<T>
  setState(path: string, value: any): void
  getState(path: string): any
}

export function CerebralTest(
  fixtures: ControllerOptions,
  options?: any
): CerebralTestType
