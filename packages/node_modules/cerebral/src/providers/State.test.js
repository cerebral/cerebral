/* eslint-env mocha */
import { Controller, Module } from '../'
import assert from 'assert'

describe('State', () => {
  it('should be able to GET state', () => {
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      signals: {
        foo: [({ state }) => assert.deepEqual(state.get(), { foo: 'bar' })],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
  })
  it('should be able to SET state', () => {
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      signals: {
        foo: [({ state }) => state.set('foo', 'bar2')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: 'bar2' })
  })
  it('should be able to SET state with an array in the path', () => {
    const rootModule = Module({
      state: { foo: ['bar'] },
      signals: {
        foo: [({ state }) => state.set('foo.0', 'baz')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['baz'] })
  })
  it('should be able to TOGGLE state', () => {
    const rootModule = Module({
      state: { foo: false },
      signals: {
        foo: [({ state }) => state.toggle('foo')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: true })
  })
  it('should be able to PUSH state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo'],
      },
      signals: {
        foo: [({ state }) => state.push('foo', 'bar')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['foo', 'bar'] })
  })
  it('should be able to MERGE state', () => {
    const rootModule = Module({
      state: {
        foo: { foo: 'bar' },
      },
      signals: {
        foo: [({ state }) => state.merge('foo', { foo2: 'bar2' })],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), {
      foo: { foo: 'bar', foo2: 'bar2' },
    })
  })
  it('should be able to POP state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo', 'bar'],
      },
      signals: {
        foo: [({ state }) => state.pop('foo')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['foo'] })
  })
  it('should be able to SHIFT state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo', 'bar'],
      },
      signals: {
        foo: [({ state }) => state.shift('foo')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['bar'] })
  })
  it('should be able to UNSHIFT state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo'],
      },
      signals: {
        foo: [({ state }) => state.unshift('foo', 'bar')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['bar', 'foo'] })
  })
  it('should be able to SPLICE state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo'],
      },
      signals: {
        foo: [({ state }) => state.splice('foo', 0, 1, 'bar')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['bar'] })
  })
  it('should be able to UNSET state', () => {
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      signals: {
        foo: [({ state }) => state.unset('foo')],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), {})
  })
  it('should be able to CONCAT state', () => {
    const rootModule = Module({
      state: {
        foo: ['foo'],
      },
      signals: {
        foo: [({ state }) => state.concat('foo', ['bar'])],
      },
    })
    const controller = Controller(rootModule)
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['foo', 'bar'] })
  })
  it('should provide a descriptive error when passing invalid value to state', () => {
    const rootModule = Module({
      state: {
        foo: '',
      },
      signals: {
        foo: [({ state }) => state.set('foo', () => {})],
      },
    })
    const controller = Controller(rootModule, {
      devtools: { init() {}, sendExecutionData() {} },
    })
    assert.throws(() => {
      controller.getSignal('foo')()
    }, Error)
  })
  it('should work with devtools', () => {
    const rootModule = Module({
      state: {
        foo: ['foo'],
      },
      signals: {
        foo: [({ state }) => state.splice('foo', 0, 1, 'bar')],
      },
    })
    const controller = Controller(rootModule, {
      devtools: { init() {}, send() {}, sendExecutionData() {} },
    })
    controller.getSignal('foo')()
    assert.deepEqual(controller.getState(), { foo: ['bar'] })
  })
})
