/* eslint-env mocha */
import { Controller, Module, ModuleClass, CerebralError } from './'
import { sequence } from './factories'
import assert from 'assert'

describe('Module', () => {
  it('should instantiate with initial state', () => {
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
    })
    const controller = new Controller(rootModule)

    assert.deepEqual(controller.getState(), { foo: 'bar' })
    assert.ok(rootModule instanceof ModuleClass)
  })
  it('should instantiate with sequences', () => {
    const rootModule = Module({
      sequences: {
        bar: [],
      },
    })
    const controller = new Controller(rootModule)

    assert.ok(controller.getSequence('bar'))
  })
  it('should instantiate with sequences defined as sequence', () => {
    const rootModule = Module({
      sequences: {
        bar: sequence('bar', []),
      },
    })
    const controller = new Controller(rootModule)

    assert.ok(controller.getSequence('bar'))
  })
  it('should run sequences with providers', () => {
    const rootModule = Module({
      modules: {
        foo: Module({
          sequences: {
            sequenceA: [
              (context) => {
                assert.equal(context.foo.get(), 'foo')
                assert.equal(context.bar.get(), 'bar')
              },
            ],
          },
          providers: {
            foo: {
              get() {
                return 'foo'
              },
            },
          },
        }),
        bar: Module({
          sequences: {
            sequenceB: [
              (context) => {
                assert.equal(context.bar.get(), 'bar')
                assert.equal(context.foo.get(), 'foo')
              },
            ],
          },
          providers: {
            bar: {
              get() {
                return 'bar'
              },
            },
          },
        }),
      },
    })
    const controller = new Controller(rootModule)

    controller.getSequence('foo.sequenceA')()
    controller.getSequence('bar.sequenceB')()
  })
  it('should be able to define sequences with sequence property', () => {
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      sequences: {
        test: ({ state }) => state.set('foo', 'bar2'),
      },
    })
    const controller = new Controller(rootModule)

    controller.getSequence('test')()
    assert.deepEqual(controller.getState(), { foo: 'bar2' })
  })
  it('should be able to define module with catch property and custom errors', () => {
    const catchError = ({ props, state }) =>
      state.set('foo', props.error.message)
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      sequences: {
        test: () => {
          throw new Error('bar2')
        },
      },
      catch: [[Error, catchError]],
    })
    const controller = new Controller(rootModule)

    controller.getSequence('test')()
    assert.deepEqual(controller.getState(), { foo: 'bar2' })
  })
  it('should be able to define module with catch property using CerebralError', () => {
    const catchError = ({ props, state }) =>
      state.set('foo', props.error.message)
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      sequences: {
        test: () => {
          throw new CerebralError('bar2')
        },
      },
      catch: [[CerebralError, catchError]],
    })
    const controller = new Controller(rootModule)

    controller.getSequence('test')()
    assert.deepEqual(controller.getState(), { foo: 'bar2' })
  })
  it('should throw when no matching custom catch type', () => {
    class TestError {}
    const catchError = ({ props, state }) =>
      state.set('foo', props.error.message)
    const rootModule = Module({
      state: {
        foo: 'bar',
      },
      sequences: {
        test: [
          () => {
            throw new TestError('bar2')
          },
        ],
      },
      catch: [[Error, catchError]],
    })
    const controller = new Controller(rootModule)

    assert.throws(() => {
      controller.getSequence('test')()
    })
    assert.deepEqual(controller.getState(), { foo: 'bar' })
  })
  it('should throw when sequence is not set properly', () => {
    assert.throws(() => {
      Controller(
        Module({
          sequences: {
            test: undefined,
          },
        })
      )
    })
  })
})
